# Docker Compose for DTLS v1.3 Interoperability Testing
# Task 9: Orchestrated testing with external implementations

version: '3.8'

networks:
  dtls_interop_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:
  # OpenSSL DTLS v1.3 Server
  openssl_server:
    build:
      context: .
      dockerfile: openssl_server.dockerfile
    ports:
      - "14433:4433/udp"
    networks:
      dtls_interop_net:
        ipv4_address: 172.20.0.10
    environment:
      - DTLS_PORT=4433
      - DTLS_VERSION=1.3
      - SSL_CERT_FILE=/app/certs/server-cert.pem
      - SSL_KEY_FILE=/app/certs/server-key.pem
    volumes:
      - ./test_results:/app/results
    healthcheck:
      test: ["CMD", "ss", "-ulpn", "sport", "=", ":4433"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    
  # WolfSSL DTLS v1.3 Server
  wolfssl_server:
    build:
      context: .
      dockerfile: wolfssl_server.dockerfile
    ports:
      - "14434:4433/udp"
    networks:
      dtls_interop_net:
        ipv4_address: 172.20.0.11
    environment:
      - DTLS_PORT=4433
      - DTLS_VERSION=1.3
    volumes:
      - ./test_results:/app/results
    depends_on:
      - openssl_server
      
  # GnuTLS DTLS v1.3 Server  
  gnutls_server:
    build:
      context: .
      dockerfile: gnutls_server.dockerfile
    ports:
      - "14435:4433/udp"
    networks:
      dtls_interop_net:
        ipv4_address: 172.20.0.12
    environment:
      - DTLS_PORT=4433
      - DTLS_VERSION=1.3
    volumes:
      - ./test_results:/app/results
    depends_on:
      - wolfssl_server
      
  # Our DTLS Implementation Test Client
  dtls_test_client:
    build:
      context: ../../..
      dockerfile: tests/interoperability/docker/our_implementation.dockerfile
    networks:
      dtls_interop_net:
        ipv4_address: 172.20.0.20
    environment:
      - TEST_MODE=client
      - TARGET_SERVERS=172.20.0.10:4433,172.20.0.11:4433,172.20.0.12:4433
      - TEST_SCENARIOS=basic_handshake,cipher_negotiation,large_data,key_update
      - OUTPUT_DIR=/app/results
    volumes:
      - ./test_results:/app/results
      - ../../..:/app/src:ro
    depends_on:
      openssl_server:
        condition: service_healthy
      wolfssl_server:
        condition: service_started
      gnutls_server:
        condition: service_started
    command: >
      sh -c "
        echo 'Starting interoperability tests...' &&
        cd /app/build &&
        ./tests/interoperability/dtls_interop_tests --gtest_filter='*OpenSSL*' --gtest_output=xml:/app/results/openssl_results.xml &&
        ./tests/interoperability/dtls_interop_tests --gtest_filter='*WolfSSL*' --gtest_output=xml:/app/results/wolfssl_results.xml &&
        ./tests/interoperability/dtls_interop_tests --gtest_filter='*GnuTLS*' --gtest_output=xml:/app/results/gnutls_results.xml &&
        echo 'Interoperability tests completed'
      "
      
  # Test Results Collector and Reporter
  test_reporter:
    build:
      context: .
      dockerfile: test_reporter.dockerfile
    networks:
      dtls_interop_net:
        ipv4_address: 172.20.0.30
    volumes:
      - ./test_results:/app/results
      - ./scripts:/app/scripts:ro
    depends_on:
      - dtls_test_client
    command: >
      sh -c "
        echo 'Generating interoperability test report...' &&
        python3 /app/scripts/generate_interop_report.py /app/results &&
        echo 'Test report generated at /app/results/interop_report.html'
      "

volumes:
  test_results:
    driver: local