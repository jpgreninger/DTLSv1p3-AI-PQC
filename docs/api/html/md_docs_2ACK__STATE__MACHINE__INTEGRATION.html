<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DTLS v1.3 Implementation: ACK Processing Integration with DTLS v1.3 Handshake State Machine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DTLS v1.3 Implementation<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">Production-ready DTLS v1.3 implementation with RFC 9147 compliance and quantum-resistant cryptography</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2ACK__STATE__MACHINE__INTEGRATION.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ACK Processing Integration with DTLS v1.3 Handshake State Machine</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md83"></a> </p>
<h1><a class="anchor" id="autotoc_md84"></a>
Overview</h1>
<p>The ACK (Acknowledgment) processing system has been integrated into the DTLS v1.3 handshake state machine to provide reliable message delivery during the handshake process. This integration ensures that handshake messages are properly acknowledged and retransmitted when necessary, improving reliability over unreliable transport layers.</p>
<h1><a class="anchor" id="autotoc_md85"></a>
Architecture</h1>
<h2><a class="anchor" id="autotoc_md86"></a>
Components</h2>
<ol type="1">
<li><b>HandshakeManager</b>: Manages ACK generation, message tracking, and retransmission logic</li>
<li><b>Connection State Machine</b>: Integrates ACK processing with handshake state transitions</li>
<li><b>ReliabilityManager</b>: Handles timeout calculations and retransmission scheduling</li>
<li><b>ACK Messages</b>: 24-bit sequence number based acknowledgment system</li>
</ol>
<h2><a class="anchor" id="autotoc_md87"></a>
Integration Points</h2>
<div class="fragment"><div class="line">Connection::handle_handshake_message()</div>
<div class="line">    ├── HandshakeManager::process_message()  // Process through reliability layer</div>
<div class="line">    ├── handle_ack_message()                 // Handle ACK-specific logic</div>
<div class="line">    └── State machine transitions            // Update connection state</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md88"></a>
State Machine Integration</h1>
<h2><a class="anchor" id="autotoc_md89"></a>
ACK Processing States</h2>
<p>The ACK processing is active during the following connection states:</p>
<ul>
<li><code>WAIT_SERVER_HELLO</code></li>
<li><code>WAIT_ENCRYPTED_EXTENSIONS</code></li>
<li><code>WAIT_CERTIFICATE_OR_CERT_REQUEST</code></li>
<li><code>WAIT_CERTIFICATE_VERIFY</code></li>
<li><code>WAIT_SERVER_FINISHED</code></li>
<li><code>WAIT_CLIENT_CERTIFICATE</code></li>
<li><code>WAIT_CLIENT_CERTIFICATE_VERIFY</code></li>
<li><code>WAIT_CLIENT_FINISHED</code></li>
</ul>
<p>ACK processing is <b>disabled</b> during:</p><ul>
<li><code>INITIAL</code> (no handshake in progress)</li>
<li><code>CONNECTED</code> (handshake complete)</li>
<li><code>CLOSED</code> (connection terminated)</li>
</ul>
<h2><a class="anchor" id="autotoc_md90"></a>
Message Flow</h2>
<div class="fragment"><div class="line">1. Receive Handshake Message</div>
<div class="line">   ├── Process through HandshakeManager (generates ACK automatically)</div>
<div class="line">   ├── Update connection state based on message type</div>
<div class="line">   └── Continue handshake progression</div>
<div class="line"> </div>
<div class="line">2. Send Handshake Message  </div>
<div class="line">   ├── HandshakeManager tracks message for reliability</div>
<div class="line">   ├── Message sent through transport layer</div>
<div class="line">   └── Start retransmission timer</div>
<div class="line"> </div>
<div class="line">3. Receive ACK Message</div>
<div class="line">   ├── HandshakeManager processes ACK ranges</div>
<div class="line">   ├── Update RTT calculations </div>
<div class="line">   ├── Cancel retransmission timers</div>
<div class="line">   └── Clean up acknowledged messages</div>
<div class="line"> </div>
<div class="line">4. Timeout Processing</div>
<div class="line">   ├── Check for unacknowledged messages</div>
<div class="line">   ├── Apply exponential backoff</div>
<div class="line">   ├── Retransmit messages or fail handshake</div>
<div class="line">   └── Update statistics</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md91"></a>
Implementation Details</h1>
<h2><a class="anchor" id="autotoc_md92"></a>
Connection Class Changes</h2>
<h3><a class="anchor" id="autotoc_md93"></a>
New Methods</h3>
<ul>
<li><code>handle_ack_message()</code>: Process received ACK messages</li>
<li><code>send_handshake_message()</code>: Send messages through HandshakeManager</li>
<li><code>should_process_ack_for_state()</code>: Determine if ACKs should be processed</li>
<li><code>process_handshake_timeouts()</code>: Handle retransmission timeouts</li>
</ul>
<h3><a class="anchor" id="autotoc_md94"></a>
HandshakeManager Integration</h3>
<div class="fragment"><div class="line"><span class="comment">// Initialize HandshakeManager with ACK support</span></div>
<div class="line">protocol::HandshakeManager::Config handshake_config;</div>
<div class="line">handshake_config.enable_ack_processing = <span class="keyword">true</span>;</div>
<div class="line">handshake_manager_ = std::make_unique&lt;protocol::HandshakeManager&gt;(handshake_config);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Setup callbacks</span></div>
<div class="line"><span class="keyword">auto</span> send_callback = [<span class="keyword">this</span>](<span class="keyword">const</span> HandshakeMessage&amp; message) -&gt; Result&lt;void&gt; {</div>
<div class="line">    <span class="keywordflow">return</span> send_handshake_message(message);</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> event_callback = [<span class="keyword">this</span>](HandshakeEvent event, <span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; data) {</div>
<div class="line">    <span class="comment">// Map handshake events to connection events</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md95"></a>
ACK Message Handling</h2>
<h3><a class="anchor" id="autotoc_md96"></a>
Automatic ACK Generation</h3>
<ul>
<li>ACKs are generated automatically when receiving handshake messages</li>
<li>ACK generation respects the current connection state</li>
<li>Out-of-order message handling with sequence number tracking</li>
</ul>
<h3><a class="anchor" id="autotoc_md97"></a>
ACK Processing Logic</h3>
<div class="fragment"><div class="line">Result&lt;void&gt; Connection::handle_ack_message(<span class="keyword">const</span> <a class="code hl_class" href="classdtls_1_1v13_1_1protocol_1_1ACK.html">protocol::ACK</a>&amp; ack_message) {</div>
<div class="line">    <span class="comment">// State validation</span></div>
<div class="line">    <span class="keywordflow">if</span> (!should_process_ack_for_state(state_)) {</div>
<div class="line">        <span class="keywordflow">return</span> make_result(); <span class="comment">// Ignore ACKs in inappropriate states</span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// HandshakeManager handles the actual processing</span></div>
<div class="line">    <span class="comment">// Connection layer performs state-specific validation</span></div>
<div class="line">    </div>
<div class="line">    update_last_activity();</div>
<div class="line">    <span class="keywordflow">return</span> make_result();</div>
<div class="line">}</div>
<div class="ttc" id="aclassdtls_1_1v13_1_1protocol_1_1ACK_html"><div class="ttname"><a href="classdtls_1_1v13_1_1protocol_1_1ACK.html">dtls::v13::protocol::ACK</a></div><div class="ttdef"><b>Definition</b> <a href="handshake_8h_source.html#l00587">handshake.h:587</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md98"></a>
Timeout Processing</h2>
<h3><a class="anchor" id="autotoc_md99"></a>
Periodic Timeout Checks</h3>
<div class="fragment"><div class="line">Result&lt;void&gt; Connection::process_handshake_timeouts() {</div>
<div class="line">    <span class="keywordflow">if</span> (!handshake_manager_ || !should_process_ack_for_state(state_)) {</div>
<div class="line">        <span class="keywordflow">return</span> make_result();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">auto</span> timeout_result = handshake_manager_-&gt;process_timeouts();</div>
<div class="line">    <span class="keywordflow">if</span> (!timeout_result) {</div>
<div class="line">        fire_event(ConnectionEvent::HANDSHAKE_FAILED);</div>
<div class="line">        <span class="keywordflow">return</span> timeout_result;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="namespacedtls_1_1v13.html#aa88261ab720fc922c9390edc33654c28">make_result</a>();</div>
<div class="line">}</div>
<div class="ttc" id="anamespacedtls_1_1v13_html_aa88261ab720fc922c9390edc33654c28"><div class="ttname"><a href="namespacedtls_1_1v13.html#aa88261ab720fc922c9390edc33654c28">dtls::v13::make_result</a></div><div class="ttdeci">Result&lt; std::decay_t&lt; T &gt; &gt; make_result(T &amp;&amp;value)</div><div class="ttdef"><b>Definition</b> <a href="result_8h_source.html#l00290">result.h:290</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md100"></a>
Retransmission Strategy</h3>
<ul>
<li>RFC 6298 RTO calculation for timeout values</li>
<li>Exponential backoff with configurable limits</li>
<li>Maximum retransmission attempts before handshake failure</li>
</ul>
<h1><a class="anchor" id="autotoc_md101"></a>
Configuration Options</h1>
<h2><a class="anchor" id="autotoc_md102"></a>
ConnectionConfig Integration</h2>
<div class="fragment"><div class="line">ConnectionConfig config;</div>
<div class="line">config.handshake_timeout = std::chrono::milliseconds(10000);     <span class="comment">// Max handshake time</span></div>
<div class="line">config.retransmission_timeout = std::chrono::milliseconds(1000); <span class="comment">// Initial RTO</span></div>
<div class="line">config.max_retransmissions = 5;                                  <span class="comment">// Max retransmit attempts</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md103"></a>
HandshakeManager Configuration</h2>
<div class="fragment"><div class="line">HandshakeManager::Config handshake_config;</div>
<div class="line">handshake_config.initial_timeout = config.retransmission_timeout;</div>
<div class="line">handshake_config.max_timeout = config.handshake_timeout;</div>
<div class="line">handshake_config.max_retransmissions = config.max_retransmissions;</div>
<div class="line">handshake_config.enable_ack_processing = <span class="keyword">true</span>;</div>
<div class="line">handshake_config.max_flight_size = 10; <span class="comment">// Max unacknowledged messages</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md104"></a>
Error Handling</h1>
<h2><a class="anchor" id="autotoc_md105"></a>
Timeout Scenarios</h2>
<ul>
<li><b>Retransmission Timeout</b>: Message retransmitted with exponential backoff</li>
<li><b>Maximum Retransmissions</b>: Handshake failed, connection terminated</li>
<li><b>Handshake Timeout</b>: Overall handshake time limit exceeded</li>
</ul>
<h2><a class="anchor" id="autotoc_md106"></a>
ACK Validation</h2>
<ul>
<li>Sequence number range validation</li>
<li>State-appropriate ACK processing</li>
<li>Duplicate ACK detection and handling</li>
</ul>
<h2><a class="anchor" id="autotoc_md107"></a>
Error Events</h2>
<ul>
<li><code>HANDSHAKE_FAILED</code>: Critical timeout or error occurred</li>
<li><code>RETRANSMISSION_NEEDED</code>: Message needs retransmission</li>
<li><code>ERROR_OCCURRED</code>: General error in ACK processing</li>
</ul>
<h1><a class="anchor" id="autotoc_md108"></a>
Statistics and Monitoring</h1>
<h2><a class="anchor" id="autotoc_md109"></a>
Handshake Statistics</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>ConnectionStats {</div>
<div class="line">    std::chrono::milliseconds handshake_duration{0};</div>
<div class="line">    uint32_t handshake_retransmissions = 0;</div>
<div class="line">    uint64_t records_sent = 0;</div>
<div class="line">    uint64_t records_received = 0;</div>
<div class="line">    uint32_t protocol_errors = 0;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md110"></a>
HandshakeManager Statistics</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>Statistics {</div>
<div class="line">    uint32_t messages_sent{0};</div>
<div class="line">    uint32_t messages_received{0};</div>
<div class="line">    uint32_t acks_sent{0};</div>
<div class="line">    uint32_t acks_received{0};</div>
<div class="line">    uint32_t retransmissions{0};</div>
<div class="line">    uint32_t messages_in_flight{0};</div>
<div class="line">    std::chrono::milliseconds current_rto{0};</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md111"></a>
Usage Examples</h1>
<h2><a class="anchor" id="autotoc_md112"></a>
Basic Integration</h2>
<div class="fragment"><div class="line"><span class="comment">// Create connection with ACK support</span></div>
<div class="line"><span class="keyword">auto</span> connection = Connection::create_client(config, crypto_provider, server_address);</div>
<div class="line">connection-&gt;initialize();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Start handshake (ACK processing happens automatically)</span></div>
<div class="line">connection-&gt;start_handshake();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Periodic timeout processing (should be called regularly)</span></div>
<div class="line"><span class="keywordflow">while</span> (handshake_in_progress) {</div>
<div class="line">    connection-&gt;process_handshake_timeouts();</div>
<div class="line">    std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md113"></a>
Event Handling</h2>
<div class="fragment"><div class="line"><span class="keyword">auto</span> event_callback = [](ConnectionEvent event, <span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; data) {</div>
<div class="line">    <span class="keywordflow">switch</span> (event) {</div>
<div class="line">        <span class="keywordflow">case</span> ConnectionEvent::HANDSHAKE_COMPLETED:</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Handshake completed successfully with ACK support\n&quot;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> ConnectionEvent::HANDSHAKE_FAILED:</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Handshake failed - may be due to ACK timeout\n&quot;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md114"></a>
Performance Considerations</h1>
<h2><a class="anchor" id="autotoc_md115"></a>
Optimization Features</h2>
<ul>
<li>Automatic ACK range optimization (merging adjacent ranges)</li>
<li>Efficient sequence number tracking</li>
<li>Minimal memory overhead for message tracking</li>
<li>Configurable retransmission parameters</li>
</ul>
<h2><a class="anchor" id="autotoc_md116"></a>
Network Adaptivity</h2>
<ul>
<li>Dynamic RTO calculation based on measured RTT</li>
<li>Exponential backoff for poor network conditions</li>
<li>Configurable timeout parameters for different environments</li>
</ul>
<h1><a class="anchor" id="autotoc_md117"></a>
Testing</h1>
<p>The integration includes comprehensive test examples:</p><ul>
<li><code>ack_state_machine_example.cpp</code>: Demonstrates state machine integration</li>
<li><code>ack_integration_test.cpp</code>: Tests reliability and retransmission features</li>
<li><code>ack_message_example.cpp</code>: Basic ACK message functionality</li>
</ul>
<h1><a class="anchor" id="autotoc_md118"></a>
Future Enhancements</h1>
<h2><a class="anchor" id="autotoc_md119"></a>
Potential Improvements</h2>
<ol type="1">
<li><b>Congestion Control</b>: Implement congestion avoidance algorithms</li>
<li><b>Network Path Changes</b>: Handle path MTU discovery and adaptation</li>
<li><b>Advanced Metrics</b>: Additional performance and reliability metrics</li>
<li><b>Configuration Profiles</b>: Predefined configurations for different network types</li>
</ol>
<h2><a class="anchor" id="autotoc_md120"></a>
Integration Points</h2>
<ol type="1">
<li><b>Record Layer</b>: Full integration with encrypted record processing</li>
<li><b>Connection Migration</b>: Support for connection ID based migration</li>
<li><b>Early Data</b>: ACK processing for 0-RTT data transmission</li>
</ol>
<h1><a class="anchor" id="autotoc_md121"></a>
Conclusion</h1>
<p>The ACK processing integration provides robust reliability for DTLS v1.3 handshake messages while maintaining clean separation of concerns between the connection state machine and reliability mechanisms. The implementation follows DTLS v1.3 specifications and provides configurable parameters for different network environments. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
